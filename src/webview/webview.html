<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Knip UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            animation: {
              spin: "spin 1s linear infinite",
            },
          },
        },
      };
    </script>
    <style>
      /* Custom styles for elements that need special handling */
      .search-input::placeholder {
        color: rgba(255, 255, 255, 0.6);
      }

      .gradient-text {
        background: linear-gradient(135deg, #81c784 0%, #4fc3f7 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .chevron {
        transition: transform 0.2s;
        color: rgba(255, 255, 255, 0.6);
        font-size: 18px;
        font-weight: bold;
      }
      .section.expanded .chevron {
        transform: rotate(90deg);
      }
      .chevron-rotate {
        transition: transform 0.2s;
      }
      .section-content {
        display: none;
      }
      .section.expanded .section-content {
        display: block;
      }
      .section.expanded .chevron-rotate {
        transform: rotate(90deg);
      }

      .item-actions {
        opacity: 0;
        transition: opacity 0.2s;
      }

      .item:hover .item-actions {
        opacity: 1;
      }
    </style>
  </head>
  <body
    class="font-sans bg-gradient-to-br from-slate-800 to-blue-900 text-white h-screen overflow-x-hidden"
  >
    <div class="p-5 h-full overflow-y-auto">
      <!-- Header -->
      <div class="flex justify-between items-center mb-5">
        <h1 class="text-2xl font-semibold tracking-wide">Knip UI</h1>
        <div class="flex gap-2.5">
          <button
            class="bg-white/10 border-none rounded-lg w-9 h-9 flex items-center justify-center cursor-pointer transition-all duration-200 text-white hover:bg-white/20 hover:-translate-y-0.5"
            onclick="rescan()"
            title="Rescan"
          >
            <span>‚Üª</span>
          </button>
          <button
            class="bg-white/10 border-none rounded-lg w-9 h-9 flex items-center justify-center cursor-pointer transition-all duration-200 text-white hover:bg-white/20 hover:-translate-y-0.5"
            onclick="toggleCollapseAll()"
            title="Collapse All"
          >
            ‚¨ç
          </button>
        </div>
      </div>

      <!-- Search Box -->
      <div id="search-box" class="relative mb-5">
        <input
          type="text"
          class="w-full py-3 px-4 pl-11 bg-white/10 border border-white/20 rounded-xl text-white text-base outline-none transition-all duration-200 focus:border-blue-400 focus:shadow-[0_0_0_3px_rgba(79,195,247,0.2)]"
          placeholder="Filter"
          onkeyup="filterItems(this.value)"
        />
        <span class="absolute left-3.5 top-1/2 -translate-y-1/2 text-white/60"
          >üîç</span
        >
      </div>

      <!-- Welcome Screen -->
      <div id="welcome-screen" class="text-center py-15 px-5">
        <h2 class="text-3xl mb-4 gradient-text">Welcome to Knip Scanner! üéâ</h2>
        <p class="text-base text-white/80 mb-7 leading-relaxed">
          Analyze your project for unused files, dependencies, and exports.<br />Get
          started by scanning your workspace.
        </p>
        <button
          class="bg-gradient-to-br from-blue-400 to-blue-500 border-none rounded-xl py-3 px-6 text-white text-base font-medium cursor-pointer transition-all duration-200 inline-flex items-center gap-2 shadow-[0_4px_15px_rgba(79,195,247,0.3)] hover:-translate-y-0.5 hover:shadow-[0_8px_25px_rgba(79,195,247,0.4)]"
          onclick="getStarted()"
        >
          <span>‚ñ∂</span>
          Get Started
        </button>
      </div>

      <!-- Install Prompt -->
      <div
        id="install-prompt"
        class="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-5 mb-5 text-center hidden"
      >
        <h3 class="text-yellow-400 mb-2.5">‚ö† Knip Not Installed</h3>
        <p class="mb-4">
          Knip is required to analyze your project. Please install it globally.
        </p>
        <div class="flex gap-2.5 justify-center mt-4">
          <button
            class="bg-white/10 border border-white/20 rounded-xl py-3 px-6 text-white text-base font-medium cursor-pointer transition-all duration-200 inline-flex items-center gap-2 hover:-translate-y-0.5 hover:bg-white/20 hover:shadow-[0_4px_15px_rgba(0,0,0,0.2)]"
            onclick="installKnip('npm')"
          >
            Install with NPM
          </button>
          <button
            class="bg-white/10 border border-white/20 rounded-xl py-3 px-6 text-white text-base font-medium cursor-pointer transition-all duration-200 inline-flex items-center gap-2 hover:-translate-y-0.5 hover:bg-white/20 hover:shadow-[0_4px_15px_rgba(0,0,0,0.2)]"
            onclick="installKnip('yarn')"
          >
            Install with Yarn
          </button>
        </div>
      </div>

      <!-- Loading Screen -->
      <div id="loading-screen" class="text-center py-10 hidden">
        <div
          class="w-10 h-10 border-4 border-white/10 border-t-blue-400 rounded-full animate-spin mx-auto mb-4"
        ></div>
        <p>Scanning your project...</p>
      </div>

      <!-- Results Container -->
      <div id="results-container" class="hidden">
        <!-- Content will be populated by JavaScript -->
      </div>
    </div>

    <script>
      const vscode = acquireVsCodeApi();
      // ‚úÖ State variables
      let currentData = null;
      let currentFilter = "";
      let expandedSections = new Set();
      let uiState = "idle"; // 'idle', 'scanning', 'results', 'error'
      let allCollapsed = false;

      // ‚úÖ 1. INITIALIZE STATE FUNCTION
      function initializeState() {
        console.log("üîß Initializing webview state");

        // Get previously saved state from webview storage
        const savedState = vscode.getState();

        if (savedState) {
          console.log("üîß Restoring saved state:", savedState);

          // Restore scan results
          if (savedState.scanResults) {
            currentData = savedState.scanResults;
            uiState = "results";
          }

          // Restore filter text
          if (savedState.filterText) {
            currentFilter = savedState.filterText;
            const searchInput = document.getElementById("search-input");
            if (searchInput) {
              searchInput.value = currentFilter;
            }
          }

          // Restore expanded sections
          if (savedState.expandedSections) {
            expandedSections = new Set(savedState.expandedSections);
          }

          // Restore UI based on saved data
          if (currentData && uiState === "results") {
            showResults(currentData);
            showStateIndicator("State Restored");
          }
        }

        // Request any additional data from extension
        vscode.postMessage({ type: "requestPreviousResults" });
      }
      // ‚úÖ 2. SAVE STATE FUNCTION
      function saveCurrentState() {
        const state = {
          scanResults: currentData,
          filterText: currentFilter,
          expandedSections: Array.from(expandedSections),
          uiState: uiState,
          timestamp: Date.now(),
        };

        console.log("üîß Saving webview state:", state);
        vscode.setState(state);
      }
      // ‚úÖ 3. MESSAGE HANDLING WITH STATE PERSISTENCE
      window.addEventListener("message", (event) => {
        const message = event.data;
        console.log("üîß Received message:", message.type);

        switch (message.type) {
          case "updateData":
            if (message.data) {
              currentData = message.data;
              uiState = "results";
              showResults(currentData);
              saveCurrentState(); // ‚úÖ Save after updating
            }
            break;

          case "scanStarted":
            uiState = "scanning";
            showLoading();
            saveCurrentState(); // ‚úÖ Save state change
            break;

          case "scanCompleted":
            currentData = message.data;
            uiState = "results";
            showResults(currentData);
            saveCurrentState(); // ‚úÖ Save after scan completion
            break;

          case "scanError":
            uiState = "error";
            showError(message.error);
            saveCurrentState(); // ‚úÖ Save error state
            break;

          case "collapseAll":
            collapseAllSections();
            saveCurrentState(); // ‚úÖ Save after UI change
            break;
        }
      });

      function getStarted() {
        vscode.postMessage({ type: "getStarted" });
      }

      function installKnip(packageManager) {
        vscode.postMessage({ type: "installKnip", packageManager });
        hideInstallPrompt();
        showScanButton();
      }

      function startScan() {
        vscode.postMessage({ type: "startScan" });
      }

      function rescan() {
        vscode.postMessage({ type: "rescan" });
      }

      function collapseAll() {
        vscode.postMessage({ type: "collapseAll" });
      }

      // ‚úÖ 6. COLLAPSE/EXPAND ALL WITH STATE PERSISTENCE
      function collapseAllSections() {
        document.querySelectorAll(".section").forEach((section) => {
          section.classList.remove("expanded");
        });
        expandedSections.clear();
        saveCurrentState();
      }

      function expandAllSections() {
        document.querySelectorAll(".section").forEach((section) => {
          section.classList.add("expanded");

          // ‚úÖ Add to expanded sections tracking with null check
          const titleElement =
            section.querySelector(".section-title span:nth-child(2)") ||
            section.querySelector(".section-title span:last-child") ||
            section.querySelector(".section-title");

          if (titleElement && titleElement.textContent) {
            expandedSections.add(titleElement.textContent.trim());
          }
        });
      }
      // ‚úÖ 7. CLEAR STATE FUNCTION FOR DEBUGGING
      function clearStoredData() {
        vscode.setState(undefined);
        currentData = null;
        currentFilter = "";
        expandedSections = new Set();
        uiState = "idle";

        // Clear UI
        document.getElementById("search-input").value = "";
        showWelcome();

        // Send message to extension to clear its state too
        vscode.postMessage({ type: "clearResults" });

        showStateIndicator("State Cleared");
      }
      function showStateIndicator(message) {
        // Create or update state indicator
        let indicator = document.getElementById("state-indicator");
        if (!indicator) {
          indicator = document.createElement("div");
          indicator.id = "state-indicator";
          indicator.style.cssText = `
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(76, 175, 80, 0.8);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s;
      `;
          document.body.appendChild(indicator);
        }

        indicator.textContent = message;
        indicator.style.opacity = "1";

        setTimeout(() => {
          indicator.style.opacity = "0";
        }, 2000);
      }
      // ‚úÖ Fixed toggle function with proper state management
      function toggleCollapseAll() {
        const toggleBtn = document.querySelector(
          '.icon-btn[onclick="toggleCollapseAll()"]'
        );

        if (allCollapsed) {
          // Currently collapsed, so expand all
          expandAllSections();
          toggleBtn.innerHTML = "‚¨ç";
          toggleBtn.title = "Collapse All";
          allCollapsed = false;
        } else {
          // Currently expanded, so collapse all
          collapseAllSections();
          toggleBtn.innerHTML = "‚¨å";
          toggleBtn.title = "Expand All";
          allCollapsed = true;
        }
      }

      function handleInstallStatus(installed) {
        if (installed) {
          hideInstallPrompt();
          showScanButton();
        } else {
          showInstallPrompt();
        }
      }

      function showInstallPrompt() {
        document.getElementById("install-prompt").classList.remove("hidden");
        document.getElementById("welcome-screen").classList.add("hidden");
        document.getElementById("results-container").classList.add("hidden");
        document.getElementById("search-box").classList.add("hidden");
      }

      function hideInstallPrompt() {
        document.getElementById("install-prompt").classList.add("hidden");
      }

      function showScanButton() {
        document.getElementById("welcome-screen").classList.remove("hidden");
        document.getElementById("welcome-screen").innerHTML = `
          <h2 class="text-3xl mb-4 gradient-text">Ready to Scan! üöÄ</h2>
          <p class="text-base text-white/80 mb-7">Knip is installed and ready to analyze your project.</p>
          <button class="bg-gradient-to-br from-blue-400 to-blue-500 border-none rounded-xl py-3 px-6 text-white text-base font-medium cursor-pointer transition-all duration-200 inline-flex items-center gap-2 shadow-[0_4px_15px_rgba(79,195,247,0.3)] hover:-translate-y-0.5 hover:shadow-[0_8px_25px_rgba(79,195,247,0.4)]" onclick="startScan()">
            <span>üîç</span>
            Start Scanning
          </button>
        `;
        document.getElementById("install-prompt").classList.add("hidden");
        document.getElementById("results-container").classList.add("hidden");
        document.getElementById("search-box").classList.add("hidden");
      }

      function showLoading() {
        document.getElementById("welcome-screen").classList.add("hidden");
        document.getElementById("install-prompt").classList.add("hidden");
        document.getElementById("results-container").classList.add("hidden");
        document.getElementById("loading-screen").classList.remove("hidden");
        document.getElementById("search-box").classList.add("hidden");
      }

      function showResults(data) {
        if (!data || uiState !== "results") return;

        // Hide other screens
        document.getElementById("loading-screen").classList.add("hidden");
        document.getElementById("welcome-screen").classList.add("hidden");
        document.getElementById("install-prompt").classList.add("hidden");

        // Show results
        document.getElementById("results-container").classList.remove("hidden");
        document.getElementById("search-box").classList.remove("hidden");

        populateResults(data);

        // ‚úÖ Restore expanded sections after populating
        setTimeout(() => {
          document.querySelectorAll(".section").forEach((section) => {
            const titleElement =
              section.querySelector(".section-title span:nth-child(2)") ||
              section.querySelector(".section-title span:last-child") ||
              section.querySelector(".section-title");

            if (
              titleElement &&
              expandedSections.has(titleElement.textContent.trim())
            ) {
              section.classList.add("expanded");
            }
          });

          // ‚úÖ Restore filter if it exists
          if (currentFilter) {
            filterItems(currentFilter);
          }
        }, 100);
      }

      function showError(error) {
        document.getElementById("results-container").classList.add("hidden");
        document.getElementById("loading-screen").classList.add("hidden");
        document.getElementById("welcome-screen").innerHTML = `
          <h2 class="text-3xl mb-4 text-red-400">Scan Failed ‚ùå</h2>
          <p class="text-base text-white/80 mb-7">Error: ${error}</p>
          <button class="bg-gradient-to-br from-blue-400 to-blue-500 border-none rounded-xl py-3 px-6 text-white text-base font-medium cursor-pointer transition-all duration-200 inline-flex items-center gap-2 shadow-[0_4px_15px_rgba(79,195,247,0.3)] hover:-translate-y-0.5 hover:shadow-[0_8px_25px_rgba(79,195,247,0.4)]" onclick="startScan()">
            <span>üîÑ</span>
            Try Again
          </button>
        `;
        document.getElementById("welcome-screen").classList.remove("hidden");
        document.getElementById("search-box").classList.add("hidden");
      }

      function populateResults(data) {
        if (!data) return;

        const container = document.getElementById("results-container");
        container.innerHTML = "";

        // Unused Files
        if (data.files && data.files.length > 0) {
          const filesSection = createSection(
            "üìÅ",
            "Unused Files",
            data.files.length
          );
          const filesContent = data.files
            .map(
              (file) => `
              <div class="item py-3 px-5 border-b border-white/5 flex justify-between items-center transition-all duration-200 hover:bg-white/5" data-filter="${file.toLowerCase()}" title="${file}">
                  <span class="font-mono text-sm">${file
                    .split("/")
                    .pop()}</span>
                  <div class="item-actions flex gap-2">
                      <button class="bg-white/10 border-none rounded-md py-1 px-2 text-white text-xs cursor-pointer transition-all duration-200 hover:bg-white/20" onclick="openFile('${file}')">Open</button>
                      <button class="bg-red-500/20 border-none rounded-md py-1 px-2 text-white text-xs cursor-pointer transition-all duration-200 hover:bg-red-500/40" onclick="deleteFile('${file}')">Delete</button>
                      <button class="bg-white/10 border-none rounded-md py-1 px-2 text-white text-xs cursor-pointer transition-all duration-200 hover:bg-white/20" onclick="ignoreFile('${file}')">Ignore</button>
                  </div>
              </div>
              `
            )
            .join("");
          filesSection.querySelector(".section-content").innerHTML =
            filesContent;
          container.appendChild(filesSection);
        }

        // Process Issues
        if (data.issues) {
          let allDependencies = [];
          let allDevDependencies = [];
          let allUnlisted = [];
          let allExports = [];
          let allTypes = [];
          let allUnresolved = [];
          let allDuplicates = [];

          data.issues.forEach((issue) => {
            allDependencies = allDependencies.concat(issue.dependencies || []);
            allDevDependencies = allDevDependencies.concat(
              issue.devDependencies || []
            );
            allUnlisted = allUnlisted.concat(issue.unlisted || []);
            allExports = allExports.concat(issue.exports || []);
            allTypes = allTypes.concat(issue.types || []);
            allUnresolved = allUnresolved.concat(issue.unresolved || []);
            allDuplicates = allDuplicates.concat(issue.duplicates || []);
          });

          // Unused Dependencies
          if (allDependencies.length > 0) {
            const depsSection = createSection(
              "üì¶",
              "Unused Dependencies",
              allDependencies.length
            );
            const depsContent = allDependencies
              .map(
                (dep) => `
                <div class="item py-3 px-5 border-b border-white/5 flex justify-between items-center transition-all duration-200 hover:bg-white/5" data-filter="${dep.name.toLowerCase()}">
                    <span class="font-mono text-sm">${dep.name}</span>
                    <div class="item-actions flex gap-2">
                        <button class="bg-red-500/20 border-none rounded-md py-1 px-2 text-white text-xs cursor-pointer transition-all duration-200 hover:bg-red-500/40" onclick="uninstallDep('${
                          dep.name
                        }')">Remove</button>
                        <button class="bg-white/10 border-none rounded-md py-1 px-2 text-white text-xs cursor-pointer transition-all duration-200 hover:bg-white/20" onclick="ignoreDep('${
                          dep.name
                        }')">Ignore</button>
                    </div>
                </div>
                `
              )
              .join("");
            depsSection.querySelector(".section-content").innerHTML =
              depsContent;
            container.appendChild(depsSection);
          }

          // Unused Dev Dependencies
          if (allDevDependencies.length > 0) {
            const devDepsSection = createSection(
              "üîß",
              "Unused Dev Dependencies",
              allDevDependencies.length
            );
            const devDepsContent = allDevDependencies
              .map(
                (dep) => `
                <div class="item py-3 px-5 border-b border-white/5 flex justify-between items-center transition-all duration-200 hover:bg-white/5" data-filter="${dep.name.toLowerCase()}">
                    <span class="font-mono text-sm">${dep.name}</span>
                    <div class="item-actions flex gap-2">
                        <button class="bg-red-500/20 border-none rounded-md py-1 px-2 text-white text-xs cursor-pointer transition-all duration-200 hover:bg-red-500/40" onclick="uninstallDep('${
                          dep.name
                        }')">Remove</button>
                        <button class="bg-white/10 border-none rounded-md py-1 px-2 text-white text-xs cursor-pointer transition-all duration-200 hover:bg-white/20" onclick="ignoreDep('${
                          dep.name
                        }')">Ignore</button>
                    </div>
                </div>
                `
              )
              .join("");
            devDepsSection.querySelector(".section-content").innerHTML =
              devDepsContent;
            container.appendChild(devDepsSection);
          }

          // Missing Dependencies (Unlisted)
          if (allUnlisted.length > 0) {
            const unlistedSection = createSection(
              "‚ö†Ô∏è",
              "Missing Dependencies",
              allUnlisted.length
            );
            const unlistedContent = allUnlisted
              .map(
                (dep) => `
                <div class="item py-3 px-5 border-b border-white/5 flex justify-between items-center transition-all duration-200 hover:bg-white/5" data-filter="${dep.name.toLowerCase()}">
                    <span class="font-mono text-sm">${dep.name}</span>
                    <div class="item-actions flex gap-2">
                        <button class="bg-white/10 border-none rounded-md py-1 px-2 text-white text-xs cursor-pointer transition-all duration-200 hover:bg-white/20" onclick="openFile('${
                          dep.file || ""
                        }')">Open</button>
                        <button class="bg-green-500/20 border-none rounded-md py-1 px-2 text-white text-xs cursor-pointer transition-all duration-200 hover:bg-green-500/40" onclick="installDep('${
                          dep.name
                        }')">Install</button>
                        <button class="bg-white/10 border-none rounded-md py-1 px-2 text-white text-xs cursor-pointer transition-all duration-200 hover:bg-white/20" onclick="ignoreDep('${
                          dep.name
                        }')">Ignore</button>
                    </div>
                </div>
                `
              )
              .join("");
            unlistedSection.querySelector(".section-content").innerHTML =
              unlistedContent;
            container.appendChild(unlistedSection);
          }

          // Unused Exports
          if (allExports.length > 0) {
            const exportsSection = createSection(
              "üì§",
              "Unused Exports",
              allExports.length
            );
            const exportsContent = allExports
              .map(
                (exp) => `
                <div class="item py-3 px-5 border-b border-white/5 flex justify-between items-center transition-all duration-200 hover:bg-white/5" data-filter="${exp.toLowerCase()}">
                    <span class="font-mono text-sm">${exp}</span>
                </div>
                `
              )
              .join("");
            exportsSection.querySelector(".section-content").innerHTML =
              exportsContent;
            container.appendChild(exportsSection);
          }

          // Unused Types
          if (allTypes.length > 0) {
            const typesSection = createSection(
              "üè∑Ô∏è",
              "Unused Types",
              allTypes.length
            );
            const typesContent = allTypes
              .map(
                (type) => `
                <div class="item py-3 px-5 border-b border-white/5 flex justify-between items-center transition-all duration-200 hover:bg-white/5" data-filter="${type.toLowerCase()}">
                    <span class="font-mono text-sm">${type}</span>
                </div>
                `
              )
              .join("");
            typesSection.querySelector(".section-content").innerHTML =
              typesContent;
            container.appendChild(typesSection);
          }

          // Unresolved Imports
          if (allUnresolved.length > 0) {
            const unresolvedSection = createSection(
              "‚ùì",
              "Unresolved Imports",
              allUnresolved.length
            );
            const unresolvedContent = allUnresolved
              .map(
                (imp) => `
                <div class="item py-3 px-5 border-b border-white/5 flex justify-between items-center transition-all duration-200 hover:bg-white/5" data-filter="${imp.toLowerCase()}">
                    <span class="font-mono text-sm">${imp}</span>
                </div>
                `
              )
              .join("");
            unresolvedSection.querySelector(".section-content").innerHTML =
              unresolvedContent;
            container.appendChild(unresolvedSection);
          }

          // Duplicates
          if (allDuplicates.length > 0) {
            const duplicatesSection = createSection(
              "üë•",
              "Duplicates",
              allDuplicates.length
            );
            const duplicatesContent = allDuplicates
              .map(
                (dup) => `
                <div class="item py-3 px-5 border-b border-white/5 flex justify-between items-center transition-all duration-200 hover:bg-white/5" data-filter="${dup.toLowerCase()}">
                    <span class="font-mono text-sm">${dup}</span>
                </div>
                `
              )
              .join("");
            duplicatesSection.querySelector(".section-content").innerHTML =
              duplicatesContent;
            container.appendChild(duplicatesSection);
          }
        }
        setTimeout(() => {
          document.querySelectorAll(".section").forEach((section) => {
            const sectionTitle = section.querySelector(
              ".section-title span:nth-child(2)"
            );
            if (
              sectionTitle &&
              expandedSections.has(sectionTitle.textContent)
            ) {
              section.classList.add("expanded");
            }
          });

          // Update button state after restoration
          updateToggleAllButtonState();
        }, 50); // Small delay to ensure DOM is ready
        if (container.innerHTML === "") {
          container.innerHTML =
            '<div class="text-center py-15 px-5"><h2 class="text-3xl mb-4 text-green-400">‚úÖ No Issues Found</h2><p class="text-base text-white/80">Your project looks clean!</p></div>';
        }
      }

      function createSection(icon, title, count) {
        const section = document.createElement("div");
        section.className =
          "section bg-white/5 rounded-xl mb-4 overflow-hidden border border-white/10 backdrop-blur-sm";
        section.innerHTML = `
          <div class="py-4 px-5 bg-white/5 border-b border-white/10 flex justify-between items-center cursor-pointer transition-all duration-200 hover:bg-white/8" onclick="toggleSection(this)">
              <div class="flex items-center gap-3 text-lg font-semibold">
                  <span>${icon}</span>
                  <span>${title}</span>
                  <span class="bg-white/20 py-1 px-2 rounded-xl text-xs font-medium">${count}</span>
              </div>
              <span class="chevron-rotate text-lg font-bold text-white/60">‚Ä∫</span>
          </div>
          <div class="section-content hidden"></div>
        `;
        return section;
      }

      function toggleSection(header) {
        const section = header.parentElement;

        // ‚úÖ Improved selector with null check
        let sectionTitle = "Unknown Section";
        const titleElement =
          section.querySelector(".section-title span:nth-child(2)") ||
          section.querySelector(".section-title span:last-child") ||
          section.querySelector(".section-title");

        if (titleElement && titleElement.textContent) {
          sectionTitle = titleElement.textContent.trim();
        }

        section.classList.toggle("expanded");

        // Update expanded sections tracking
        if (section.classList.contains("expanded")) {
          expandedSections.add(sectionTitle);
        } else {
          expandedSections.delete(sectionTitle);
        }

        // ‚úÖ Save state after toggling
        saveCurrentState();
      }

      function updateToggleAllButtonState() {
        const sections = document.querySelectorAll(".section");
        const expandedCount =
          document.querySelectorAll(".section.expanded").length;
        const toggleBtn = document.querySelector(
          '.icon-btn[onclick="toggleCollapseAll()"]'
        );

        if (!toggleBtn) return;

        if (expandedCount === 0) {
          // All collapsed
          toggleBtn.innerHTML = "‚¨å";
          toggleBtn.title = "Expand All";
          allCollapsed = true;
        } else if (expandedCount === sections.length) {
          // All expanded
          toggleBtn.innerHTML = "‚¨ç";
          toggleBtn.title = "Collapse All";
          allCollapsed = false;
        } else {
          // Mixed state - show collapse option
          toggleBtn.innerHTML = "‚¨ç";
          toggleBtn.title = "Collapse All";
          allCollapsed = false;
        }
      }
      function filterItems(query) {
        currentFilter = query;
        const items = document.querySelectorAll(".item");
        const lowerQuery = query.toLowerCase();

        items.forEach((item) => {
          const filterText = item.getAttribute("data-filter") || "";
          if (filterText.includes(lowerQuery)) {
            item.style.display = "flex";
          } else {
            item.style.display = "none";
          }
        });

        // ‚úÖ Save state after filtering
        saveCurrentState();
      }

      function openFile(filePath) {
        vscode.postMessage({ type: "openFile", filePath });
      }

      function deleteFile(filePath) {
        vscode.postMessage({ type: "deleteFile", filePath });
      }

      function installDep(dependency) {
        vscode.postMessage({ type: "installDep", dependency });
      }

      function uninstallDep(dependency) {
        vscode.postMessage({ type: "uninstallDep", dependency });
      }

      function ignoreDep(dependency) {
        vscode.postMessage({ type: "ignoreDep", dependency });
      }

      function ignoreFile(filePath) {
        vscode.postMessage({ type: "ignoreFile", filePath });
      }

      // ‚úÖ 9. INITIALIZATION
      // Initialize state when DOM is ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initializeState);
      } else {
        initializeState();
      }

      // Add event listener for search input
      document.addEventListener("DOMContentLoaded", () => {
        const searchInput = document.getElementById("search-input");
        if (searchInput) {
          searchInput.addEventListener("input", (e) => {
            filterItems(e.target.value);
          });
        }
      });

      // ‚úÖ 10. EXTENSION-SIDE COORDINATION
      // Request initial data if no saved state exists
      setTimeout(() => {
        if (!currentData && uiState === "idle") {
          getStarted();
        }
      }, 200);
    </script>
  </body>
</html>
